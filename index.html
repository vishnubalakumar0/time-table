<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Timetable Generator - Enhanced</title>

    <!-- React and ReactDOM from CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #667eea;
            --primary-dark: #5568d3;
            --secondary: #764ba2;
            --accent: #f093fb;
            --success: #48bb78;
            --danger: #f56565;
            --warning: #ed8936;
            --bg: #ffffff;
            --bg-secondary: #f7fafc;
            --text: #2d3748;
            --text-secondary: #4a5568;
            --border: #e2e8f0;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --primary: #7c3aed;
            --primary-dark: #6d28d9;
            --secondary: #a855f7;
            --accent: #c084fc;
            --bg: #1a202c;
            --bg-secondary: #2d3748;
            --text: #f7fafc;
            --text-secondary: #cbd5e0;
            --border: #4a5568;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg);
            color: var(--text);
            transition: all 0.3s ease;
            overflow-x: hidden;
        }

        /* ==================== ANIMATED BACKGROUND ==================== */
        .animated-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        }

        .particle {
            position: absolute;
            border-radius: 50%;
            animation: float 20s infinite;
            opacity: 0.6;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0) translateX(0) rotate(0deg);
            }
            25% {
                transform: translateY(-100px) translateX(100px) rotate(90deg);
            }
            50% {
                transform: translateY(-50px) translateX(-100px) rotate(180deg);
            }
            75% {
                transform: translateY(-150px) translateX(50px) rotate(270deg);
            }
        }

        .wave {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100px;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 120"><path d="M985.66,92.83C906.67,72,823.78,31,743.84,14.19c-82.26-17.34-168.06-16.33-250.45.39-57.84,11.73-114,31.07-172,41.86A600.21,600.21,0,0,1,0,27.35V120H1200V95.8C1132.19,118.92,1055.71,111.31,985.66,92.83Z" fill="rgba(255,255,255,0.1)"></path></svg>');
            background-size: cover;
            animation: wave 10s linear infinite;
        }

        @keyframes wave {
            0% { background-position-x: 0; }
            100% { background-position-x: 1200px; }
        }

        /* ==================== LOGIN PAGE ==================== */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
        }

        .login-box {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 50px 40px;
            border-radius: 30px;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 450px;
            animation: slideUp 0.6s ease-out;
            position: relative;
            overflow: hidden;
        }

        [data-theme="dark"] .login-box {
            background: rgba(26, 32, 44, 0.95);
        }

        .login-box::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(102, 126, 234, 0.1), transparent);
            animation: rotate 6s linear infinite;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
            z-index: 1;
        }

        .login-icon {
            font-size: 60px;
            margin-bottom: 20px;
            display: inline-block;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .login-title {
            font-size: 2em;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .login-subtitle {
            color: var(--text-secondary);
            font-size: 0.95em;
        }

        .form-group {
            margin-bottom: 25px;
            position: relative;
            z-index: 1;
        }

        .input-wrapper {
            position: relative;
        }

        .input-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 20px;
            color: var(--primary);
        }

        input, select {
            width: 100%;
            padding: 15px 15px 15px 50px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 15px;
            background: var(--bg);
            color: var(--text);
            transition: all 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transition: width 0.6s, height 0.6s, top 0.6s, left 0.6s;
            transform: translate(-50%, -50%);
            z-index: -1;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f56565, #e53e3e);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
        }

        .demo-credentials {
            margin-top: 30px;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 15px;
            font-size: 13px;
            position: relative;
            z-index: 1;
        }

        .demo-credentials h4 {
            margin-bottom: 12px;
            color: var(--primary);
        }

        .demo-item {
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .demo-item:last-child {
            border-bottom: none;
        }

        /* ==================== DASHBOARD ==================== */
        .dashboard-wrapper {
            min-height: 100vh;
            background: var(--bg-secondary);
        }

        .header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.6em;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .theme-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            padding: 10px 15px;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            font-size: 22px;
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1) rotate(20deg);
        }

        .btn-sm {
            padding: 10px 20px;
            font-size: 14px;
        }

        /* ==================== SCROLLABLE SECTIONS ==================== */
        .dashboard-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .section {
            background: var(--bg);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px var(--shadow);
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--primary);
        }

        .section-icon {
            font-size: 32px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .section-title {
            font-size: 1.6em;
            color: var(--primary);
            margin: 0;
        }

        .card {
            background: var(--bg-secondary);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            transition: all 0.3s;
        }

        .card:hover {
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
            transform: translateY(-2px);
        }

        .card h3 {
            margin-bottom: 20px;
            color: var(--primary);
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
            font-size: 14px;
        }

        input[type="number"] {
            padding: 12px 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: var(--bg);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px var(--shadow);
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background: var(--bg-secondary);
        }

        .staff-number {
            display: inline-block;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 12px;
            margin-right: 8px;
        }

        .hours-tracker {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .hours-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .hours-item {
            flex: 1;
            min-width: 150px;
        }

        .hours-label {
            font-size: 13px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .hours-value {
            font-size: 2em;
            font-weight: 700;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            margin-top: 12px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: white;
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .alert {
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-weight: 500;
            animation: slideDown 0.4s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert-success {
            background: linear-gradient(135deg, #c6f6d5, #9ae6b4);
            color: #22543d;
            border-left: 4px solid #48bb78;
        }

        .alert-error {
            background: linear-gradient(135deg, #fed7d7, #fc8181);
            color: #742a2a;
            border-left: 4px solid #f56565;
        }

        /* ==================== TIMETABLE GRID ==================== */
        .timetable-grid {
            display: grid;
            grid-template-columns: 100px repeat(6, 1fr);
            gap: 2px;
            background: var(--border);
            border: 2px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            margin-top: 20px;
        }

        .timetable-cell {
            background: var(--bg);
            padding: 15px 10px;
            text-align: center;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 13px;
            transition: all 0.3s;
        }

        .timetable-cell:hover {
            transform: scale(1.05);
            z-index: 10;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .timetable-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            font-weight: 600;
            padding: 12px;
        }

        .timetable-day {
            background: var(--bg-secondary);
            font-weight: 600;
            color: var(--text);
        }

        .subject-core { background: linear-gradient(135deg, #e6f7ff, #b3e0ff); color: #0066cc; font-weight: 600; }
        .subject-elective { background: linear-gradient(135deg, #fff4e6, #ffe0b3); color: #cc6600; font-weight: 600; }
        .subject-lab { background: linear-gradient(135deg, #e6ffe6, #b3ffb3); color: #00cc00; font-weight: 600; }
        .subject-other { background: linear-gradient(135deg, #ffe6f0, #ffb3d9); color: #cc0066; font-weight: 600; }
        .subject-free { background: #f0f0f0; color: #999; }

        [data-theme="dark"] .subject-core { background: linear-gradient(135deg, #003366, #004d99); color: #66b3ff; }
        [data-theme="dark"] .subject-elective { background: linear-gradient(135deg, #663300, #994d00); color: #ffb366; }
        [data-theme="dark"] .subject-lab { background: linear-gradient(135deg, #006600, #009900); color: #66ff66; }
        [data-theme="dark"] .subject-other { background: linear-gradient(135deg, #660033, #990050); color: #ff66b3; }

        .subject-name {
            font-weight: 700;
            margin-bottom: 6px;
            font-size: 14px;
        }

        .teacher-name {
            font-size: 11px;
            opacity: 0.85;
        }

        /* ==================== MOBILE RESPONSIVE ==================== */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                padding: 20px;
            }

            .header h1 {
                font-size: 1.3em;
            }

            .header-actions {
                width: 100%;
                justify-content: space-between;
            }

            .dashboard-content {
                padding: 20px 10px;
            }

            .section {
                padding: 20px;
                border-radius: 15px;
            }

            .section-title {
                font-size: 1.3em;
            }

            .grid-2 {
                grid-template-columns: 1fr;
            }

            .timetable-grid {
                grid-template-columns: 80px repeat(6, 1fr);
                font-size: 11px;
                gap: 1px;
            }

            .timetable-cell {
                padding: 10px 5px;
                min-height: 60px;
            }

            .subject-name {
                font-size: 12px;
            }

            .teacher-name {
                font-size: 10px;
            }

            .login-box {
                padding: 35px 25px;
            }

            .login-title {
                font-size: 1.5em;
            }

            .btn {
                padding: 14px;
            }

            th, td {
                padding: 10px;
                font-size: 13px;
            }
        }

        @media print {
            .no-print {
                display: none !important;
            }

            .section {
                box-shadow: none;
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // ==================== STORAGE UTILITY ====================
        const Storage = {
            get: (key) => {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : null;
                } catch (error) {
                    return null;
                }
            },
            set: (key, value) => {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                } catch (error) {
                    console.error('Error:', error);
                }
            }
        };

        // Initialize data
        const initializeData = () => {
            if (!Storage.get('classes')) Storage.set('classes', []);
            if (!Storage.get('staff')) {
                Storage.set('staff', [
                    { id: 1, name: 'Admin User', username: 'admin', password: 'admin123', role: 'admin' },
                    { id: 2, name: 'Dr. Alice Smith', username: 'alice', password: 'staff123', role: 'staff', freePeriodMode: 'manual', manualFreePeriods: 5 },
                    { id: 3, name: 'Student User', username: 'student', password: 'student123', role: 'student', className: '' }
                ]);
            }
            if (!Storage.get('subjects')) Storage.set('subjects', []);
            if (!Storage.get('timetable')) Storage.set('timetable', null);
        };


        // ==================== ENHANCED TIMETABLE GENERATOR ====================
        class EnhancedTimetableGenerator {
            constructor(classes, staff, subjects) {
                this.classes = classes;
                this.staff = staff;
                this.subjects = subjects;
                this.classTimetables = {};
                this.staffTimetables = {};
                this.teacherBusySlots = {};
                this.teacherWeeklyCount = {};
                this.teacherDailyCount = {};
                this.DAYS = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
                this.PERIODS = 6;
            }

            validate() {
                const errors = [];

                if (this.classes.length === 0) errors.push('No classes added');
                if (this.staff.filter(s => s.role === 'staff').length === 0) errors.push('No staff added');
                if (this.subjects.length === 0) errors.push('No subjects added');

                if (errors.length > 0) return { valid: false, errors };

                // Validate class hours = 30 (NO FREE PERIODS)
                const classHours = {};
                this.subjects.forEach(subject => {
                    classHours[subject.className] = (classHours[subject.className] || 0) + subject.hoursPerWeek;
                });

                this.classes.forEach(cls => {
                    const hours = classHours[cls.name] || 0;
                    if (hours !== 30) {
                        errors.push(`Class ${cls.name}: Has ${hours} hours, needs exactly 30 (no free periods allowed)`);
                    }
                });

                // Validate teacher workload
                const teacherHours = {};
                this.subjects.forEach(subject => {
                    teacherHours[subject.teacher] = (teacherHours[subject.teacher] || 0) + subject.hoursPerWeek;
                });

                this.staff.filter(s => s.role === 'staff').forEach(teacher => {
                    const totalHours = teacherHours[teacher.name] || 0;
                    if (teacher.freePeriodMode === 'manual') {
                        const maxHours = 30 - teacher.manualFreePeriods;
                        if (totalHours > maxHours) {
                            errors.push(`${teacher.name}: Assigned ${totalHours}h exceeds max ${maxHours}h`);
                        }
                    }
                });

                // Validate continuous subjects
                this.subjects.filter(s => s.isContinuous).forEach(subject => {
                    if (![2, 3].includes(subject.blockSize)) {
                        errors.push(`${subject.name}: Block size must be 2 or 3`);
                    }
                    if (subject.hoursPerWeek % subject.blockSize !== 0) {
                        errors.push(`${subject.name}: Hours (${subject.hoursPerWeek}) must be divisible by block size (${subject.blockSize})`);
                    }
                });

                return { valid: errors.length === 0, errors };
            }

            generate() {
                this._initialize();

                for (const cls of this.classes) {
                    if (!this._generateClassTimetable(cls.name)) {
                        return { success: false, error: `Failed to generate timetable for ${cls.name}. Try adjusting subject hours or reducing labs.` };
                    }
                }

                // Check if teacher schedules are balanced
                if (!this._checkTeacherBalance()) {
                    return { success: false, error: 'Teacher schedules too unbalanced. Please adjust assignments.' };
                }

                this._generateStaffTimetables();

                return {
                    success: true,
                    classTimetables: this.classTimetables,
                    staffTimetables: this.staffTimetables
                };
            }

            _initialize() {
                this.classes.forEach(cls => {
                    this.classTimetables[cls.name] = this.DAYS.map(() => Array(this.PERIODS).fill(null));
                });

                this.staff.filter(s => s.role === 'staff').forEach(teacher => {
                    this.teacherBusySlots[teacher.name] = {};
                    this.teacherWeeklyCount[teacher.name] = 0;
                    this.teacherDailyCount[teacher.name] = this.DAYS.reduce((acc, day) => {
                        acc[day] = 0;
                        return acc;
                    }, {});
                });
            }

            _generateClassTimetable(className) {
                const classSubjects = this.subjects.filter(s => s.className === className);

                // Reset
                classSubjects.forEach(s => s.placedHours = 0);

                // Priority 1: LABS (continuous blocks)
                const labs = classSubjects.filter(s => s.isContinuous);
                labs.sort((a, b) => b.hoursPerWeek - a.hoursPerWeek); // Larger labs first

                for (const lab of labs) {
                    if (!this._placeContinuousSubject(className, lab)) {
                        return false;
                    }
                }

                // Priority 2: CORE subjects (distribute well)
                const coreSubjects = classSubjects.filter(s => s.subjectType === 'Core' && !s.isContinuous);
                coreSubjects.sort((a, b) => b.hoursPerWeek - a.hoursPerWeek);

                for (const subject of coreSubjects) {
                    if (!this._placeRegularSubject(className, subject, true)) {
                        return false;
                    }
                }

                // Priority 3: ELECTIVES & OTHERS
                const others = classSubjects.filter(s => ['Elective', 'Other'].includes(s.subjectType) && !s.isContinuous);

                for (const subject of others) {
                    if (!this._placeRegularSubject(className, subject, false)) {
                        return false;
                    }
                }

                return true;
            }

            _placeContinuousSubject(className, subject) {
                const blocksNeeded = subject.hoursPerWeek / subject.blockSize;
                let blocksPlaced = 0;

                // Generate possible continuous slots
                const possibleSlots = [];
                this.DAYS.forEach(day => {
                    for (let start = 0; start <= this.PERIODS - subject.blockSize; start++) {
                        // Avoid first period for labs (80% chance)
                        if (start === 0 && Math.random() < 0.8) continue;
                        // Avoid last period start for 3-block labs
                        if (subject.blockSize === 3 && start > 3) continue;

                        possibleSlots.push({ day, start });
                    }
                });

                // RANDOMIZE heavily
                this._shuffle(possibleSlots);
                this._shuffle(possibleSlots); // Extra shuffle for more randomness

                for (const {day, start} of possibleSlots) {
                    if (blocksPlaced >= blocksNeeded) break;

                    // Check if entire block can be placed
                    let canPlace = true;
                    for (let i = 0; i < subject.blockSize; i++) {
                        const period = start + i;
                        const dayIndex = this.DAYS.indexOf(day);

                        if (this.classTimetables[className][dayIndex][period]) {
                            canPlace = false;
                            break;
                        }

                        const slotKey = `${day}-P${period + 1}`;
                        if (this.teacherBusySlots[subject.teacher]?.[slotKey]) {
                            canPlace = false;
                            break;
                        }

                        if (!this._checkTeacherLimit(subject.teacher)) {
                            canPlace = false;
                            break;
                        }

                        // Check teacher daily balance
                        if (this.teacherDailyCount[subject.teacher][day] >= 7) {
                            canPlace = false;
                            break;
                        }
                    }

                    if (canPlace) {
                        // Place the block
                        for (let i = 0; i < subject.blockSize; i++) {
                            const period = start + i;
                            const dayIndex = this.DAYS.indexOf(day);
                            const slotKey = `${day}-P${period + 1}`;

                            this.classTimetables[className][dayIndex][period] = {
                                subject: subject.name,
                                teacher: subject.teacher,
                                type: subject.subjectType
                            };

                            if (!this.teacherBusySlots[subject.teacher]) {
                                this.teacherBusySlots[subject.teacher] = {};
                            }
                            this.teacherBusySlots[subject.teacher][slotKey] = true;
                            this.teacherWeeklyCount[subject.teacher]++;
                            this.teacherDailyCount[subject.teacher][day]++;
                        }
                        blocksPlaced++;
                    }
                }

                return blocksPlaced === blocksNeeded;
            }

            _placeRegularSubject(className, subject, isCore) {
                const hoursToPlace = subject.hoursPerWeek;
                let placed = 0;
                const subjectPlacedDays = new Set();
                const subjectCountPerDay = {};
                this.DAYS.forEach(day => subjectCountPerDay[day] = 0);

                // Create smart slot distribution
                const possibleSlots = [];
                this.DAYS.forEach((day, dayIdx) => {
                    for (let period = 0; period < this.PERIODS; period++) {
                        // Avoid first/last period for heavy subjects (core with >3 hours)
                        if (isCore && subject.hoursPerWeek > 3) {
                            if ((period === 0 || period === 5) && Math.random() < 0.6) continue;
                        }

                        // Prefer morning (periods 1-3) for core subjects
                        const priority = isCore && period < 3 ? 10 : 1;
                        for (let i = 0; i < priority; i++) {
                            possibleSlots.push({ day, dayIdx, period });
                        }
                    }
                });

                // MAXIMUM RANDOMIZATION
                for (let i = 0; i < 5; i++) {
                    this._shuffle(possibleSlots);
                }

                for (const {day, dayIdx, period} of possibleSlots) {
                    if (placed >= hoursToPlace) break;

                    const slotKey = `${day}-P${period + 1}`;

                    // All constraints
                    if (this.classTimetables[className][dayIdx][period]) continue;
                    if (this.teacherBusySlots[subject.teacher]?.[slotKey]) continue;
                    if (!this._checkTeacherLimit(subject.teacher)) continue;

                    // MAX 2 per day constraint
                    if (subjectCountPerDay[day] >= 2) continue;

                    // NO CONSECUTIVE DAYS with same subject (NEW)
                    if (placed > 0) {
                        const prevDayIdx = (dayIdx - 1 + this.DAYS.length) % this.DAYS.length;
                        const nextDayIdx = (dayIdx + 1) % this.DAYS.length;

                        if (dayIdx > 0 && subjectPlacedDays.has(this.DAYS[prevDayIdx])) {
                            if (Math.random() < 0.9) continue; // 90% avoid consecutive days
                        }
                    }

                    // Avoid back-to-back in same day
                    if (period > 0) {
                        const prev = this.classTimetables[className][dayIdx][period - 1];
                        if (prev?.subject === subject.name && Math.random() < 0.8) continue;
                    }

                    // Check teacher daily balance
                    if (this.teacherDailyCount[subject.teacher][day] >= 7) continue;

                    // Place the subject
                    this.classTimetables[className][dayIdx][period] = {
                        subject: subject.name,
                        teacher: subject.teacher,
                        type: subject.subjectType
                    };

                    if (!this.teacherBusySlots[subject.teacher]) {
                        this.teacherBusySlots[subject.teacher] = {};
                    }
                    this.teacherBusySlots[subject.teacher][slotKey] = true;
                    this.teacherWeeklyCount[subject.teacher]++;
                    this.teacherDailyCount[subject.teacher][day]++;
                    subjectCountPerDay[day]++;
                    subjectPlacedDays.add(day);
                    placed++;
                }

                return placed === hoursToPlace;
            }

            _checkTeacherLimit(teacherName) {
                const teacher = this.staff.find(s => s.name === teacherName);
                if (!teacher) return false;

                const maxHours = teacher.freePeriodMode === 'manual' 
                    ? 30 - teacher.manualFreePeriods 
                    : 30;

                return this.teacherWeeklyCount[teacherName] < maxHours;
            }

            _checkTeacherBalance() {
                // Check if any teacher has too many classes on one day
                for (const teacher of this.staff.filter(s => s.role === 'staff')) {
                    const dailyCounts = Object.values(this.teacherDailyCount[teacher.name] || {});
                    const maxDaily = Math.max(...dailyCounts);
                    const minDaily = Math.min(...dailyCounts.filter(c => c > 0));

                    // If difference > 4, it's unbalanced
                    if (maxDaily - minDaily > 4) {
                        return false;
                    }
                }
                return true;
            }

            _generateStaffTimetables() {
                this.staff.filter(s => s.role === 'staff').forEach(teacher => {
                    this.staffTimetables[teacher.name] = this.DAYS.map(() => 
                        Array(this.PERIODS).fill({ subject: 'FREE', class: '-', type: 'free' })
                    );
                });

                this.classes.forEach(cls => {
                    this.DAYS.forEach((day, dayIndex) => {
                        this.classTimetables[cls.name][dayIndex].forEach((slot, period) => {
                            if (slot) {
                                this.staffTimetables[slot.teacher][dayIndex][period] = {
                                    subject: slot.subject,
                                    class: cls.name,
                                    type: slot.type
                                };
                            }
                        });
                    });
                });
            }

            _shuffle(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }
        }

        // PDF Export
        const exportToPDF = (elementId, filename) => {
            const element = document.getElementById(elementId);
            html2canvas(element, {
                scale: 2,
                logging: false,
                backgroundColor: '#ffffff'
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({
                    orientation: 'landscape',
                    unit: 'px',
                    format: [canvas.width, canvas.height]
                });
                pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                pdf.save(filename);
            });
        };


        // ==================== COMPONENTS ====================

        // Animated Background
        const AnimatedBackground = () => {
            const particles = useMemo(() => {
                return Array.from({ length: 20 }, (_, i) => ({
                    id: i,
                    size: Math.random() * 60 + 20,
                    left: Math.random() * 100,
                    top: Math.random() * 100,
                    delay: Math.random() * 20,
                    duration: Math.random() * 10 + 15
                }));
            }, []);

            return (
                <div className="animated-bg">
                    {particles.map(p => (
                        <div
                            key={p.id}
                            className="particle"
                            style={{
                                width: `${p.size}px`,
                                height: `${p.size}px`,
                                left: `${p.left}%`,
                                top: `${p.top}%`,
                                animationDelay: `${p.delay}s`,
                                animationDuration: `${p.duration}s`,
                                background: `radial-gradient(circle, rgba(255,255,255,0.8), transparent)`
                            }}
                        />
                    ))}
                    <div className="wave"></div>
                </div>
            );
        };

        // Theme Toggle
        const ThemeToggle = () => {
            const [theme, setTheme] = useState('light');

            useEffect(() => {
                document.documentElement.setAttribute('data-theme', theme);
            }, [theme]);

            return (
                <button 
                    className="theme-toggle"
                    onClick={() => setTheme(theme === 'light' ? 'dark' : 'light')}
                    title="Toggle theme"
                >
                    {theme === 'light' ? 'üåô' : '‚òÄÔ∏è'}
                </button>
            );
        };

        // Login Component
        const Login = ({ onLogin }) => {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            const handleLogin = (e) => {
                e.preventDefault();
                const staff = Storage.get('staff') || [];
                const user = staff.find(s => s.username === username && s.password === password);

                if (user) {
                    onLogin(user);
                } else {
                    setError('Invalid credentials! Please try again.');
                }
            };

            return (
                <>
                    <AnimatedBackground />
                    <div className="login-container">
                        <div className="login-box">
                            <div className="login-header">
                                <div className="login-icon">üè´</div>
                                <h1 className="login-title">Smart Timetable</h1>
                                <p className="login-subtitle">AI-Powered Class Scheduling System</p>
                            </div>

                            {error && <div className="alert alert-error">{error}</div>}

                            <form onSubmit={handleLogin}>
                                <div className="form-group">
                                    <div className="input-wrapper">
                                        <span className="input-icon">üë§</span>
                                        <input
                                            type="text"
                                            value={username}
                                            onChange={(e) => setUsername(e.target.value)}
                                            placeholder="Enter username"
                                            required
                                        />
                                    </div>
                                </div>

                                <div className="form-group">
                                    <div className="input-wrapper">
                                        <span className="input-icon">üîí</span>
                                        <input
                                            type="password"
                                            value={password}
                                            onChange={(e) => setPassword(e.target.value)}
                                            placeholder="Enter password"
                                            required
                                        />
                                    </div>
                                </div>

                                <button type="submit" className="btn btn-primary">
                                    üöÄ Login
                                </button>
                            </form>

                            <div className="demo-credentials">
                                <h4>üîë Demo Credentials</h4>
                                <div className="demo-item">
                                    <strong>Admin:</strong> admin / admin123
                                </div>
                                <div className="demo-item">
                                    <strong>Staff:</strong> alice / staff123
                                </div>
                                <div className="demo-item">
                                    <strong>Student:</strong> student / student123
                                </div>
                            </div>
                        </div>
                    </div>
                </>
            );
        };

        // Timetable Grid Component
        const TimetableGrid = ({ timetable, className }) => {
            if (!timetable || !timetable[className]) {
                return <div style={{padding: '40px', textAlign: 'center', color: 'var(--text-secondary)'}}>
                    No timetable generated yet
                </div>;
            }

            const grid = timetable[className];

            return (
                <div id="timetable-export" className="timetable-grid">
                    <div className="timetable-header">Day/Period</div>
                    {[...Array(6)].map((_, i) => (
                        <div key={i} className="timetable-header">P{i + 1}</div>
                    ))}

                    {['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'].map((day, dayIndex) => (
                        <React.Fragment key={day}>
                            <div className="timetable-day">{day}</div>
                            {grid[dayIndex].map((slot, periodIndex) => (
                                <div 
                                    key={periodIndex} 
                                    className={`timetable-cell subject-${slot ? slot.type.toLowerCase() : 'free'}`}
                                >
                                    {slot ? (
                                        <>
                                            <div className="subject-name">{slot.subject}</div>
                                            <div className="teacher-name">{slot.teacher}</div>
                                        </>
                                    ) : (
                                        <div style={{ color: '#999' }}>-</div>
                                    )}
                                </div>
                            ))}
                        </React.Fragment>
                    ))}
                </div>
            );
        };

        // Staff Timetable Grid
        const StaffTimetableGrid = ({ timetable, staffName }) => {
            if (!timetable || !timetable[staffName]) {
                return <div style={{padding: '40px', textAlign: 'center', color: 'var(--text-secondary)'}}>
                    No timetable generated yet
                </div>;
            }

            const grid = timetable[staffName];

            return (
                <div id="staff-timetable-export" className="timetable-grid">
                    <div className="timetable-header">Day/Period</div>
                    {[...Array(6)].map((_, i) => (
                        <div key={i} className="timetable-header">P{i + 1}</div>
                    ))}

                    {['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'].map((day, dayIndex) => (
                        <React.Fragment key={day}>
                            <div className="timetable-day">{day}</div>
                            {grid[dayIndex].map((slot, periodIndex) => (
                                <div 
                                    key={periodIndex} 
                                    className={`timetable-cell subject-${slot.type.toLowerCase()}`}
                                >
                                    {slot.subject !== 'FREE' ? (
                                        <>
                                            <div className="subject-name">{slot.subject}</div>
                                            <div className="teacher-name">{slot.class}</div>
                                        </>
                                    ) : (
                                        <div style={{ color: '#999' }}>FREE</div>
                                    )}
                                </div>
                            ))}
                        </React.Fragment>
                    ))}
                </div>
            );
        };

        // Hours Tracker Component
        const HoursTracker = ({ className, subjects, totalRequired = 30 }) => {
            const allocated = subjects
                .filter(s => s.className === className)
                .reduce((sum, s) => sum + s.hoursPerWeek, 0);

            const remaining = totalRequired - allocated;
            const percentage = (allocated / totalRequired) * 100;

            return (
                <div className="hours-tracker">
                    <div className="hours-info">
                        <div className="hours-item">
                            <div className="hours-label">Allocated</div>
                            <div className="hours-value">{allocated}</div>
                        </div>
                        <div className="hours-item">
                            <div className="hours-label">Remaining</div>
                            <div className="hours-value">{remaining}</div>
                        </div>
                        <div className="hours-item">
                            <div className="hours-label">Total Required</div>
                            <div className="hours-value">{totalRequired}</div>
                        </div>
                    </div>
                    <div className="progress-bar">
                        <div 
                            className="progress-fill" 
                            style={{ width: `${Math.min(percentage, 100)}%` }}
                        />
                    </div>
                    {remaining === 0 && (
                        <div style={{ marginTop: '10px', textAlign: 'center', fontWeight: 'bold' }}>
                            ‚úì Perfect! No free periods.
                        </div>
                    )}
                    {remaining < 0 && (
                        <div style={{ marginTop: '10px', textAlign: 'center', fontWeight: 'bold', color: '#ff4444' }}>
                            ‚ö† Over allocated by {Math.abs(remaining)} hours!
                        </div>
                    )}
                </div>
            );
        };


        // Admin Dashboard - Vertical Scrolling Sections
        const AdminDashboard = ({ user, onLogout }) => {
            const [classes, setClasses] = useState(Storage.get('classes') || []);
            const [staff, setStaff] = useState(Storage.get('staff') || []);
            const [subjects, setSubjects] = useState(Storage.get('subjects') || []);
            const [timetable, setTimetable] = useState(Storage.get('timetable'));
            const [message, setMessage] = useState(null);

            const teachers = staff.filter(s => s.role === 'staff');

            // Class Management (NO SECTION - removed as requested)
            const [newClass, setNewClass] = useState({ name: '' });

            const addClass = () => {
                if (!newClass.name) {
                    showMessage('Please enter class name', 'error');
                    return;
                }
                if (classes.find(c => c.name === newClass.name)) {
                    showMessage('Class already exists', 'error');
                    return;
                }
                const updated = [...classes, { id: Date.now(), name: newClass.name }];
                setClasses(updated);
                Storage.set('classes', updated);
                setNewClass({ name: '' });
                showMessage('Class added successfully! ‚úì', 'success');
            };

            const deleteClass = (id) => {
                if (!confirm('Delete this class? Related subjects will also be deleted.')) return;
                const updated = classes.filter(c => c.id !== id);
                setClasses(updated);
                Storage.set('classes', updated);
                const cls = classes.find(c => c.id === id);
                const updatedSubjects = subjects.filter(s => s.className !== cls?.name);
                setSubjects(updatedSubjects);
                Storage.set('subjects', updatedSubjects);
                showMessage('Class deleted successfully', 'success');
            };

            // Staff Management (WITH SERIAL NUMBERS)
            const [newStaff, setNewStaff] = useState({
                name: '',
                username: '',
                password: '',
                freePeriodMode: 'auto',
                manualFreePeriods: 0
            });

            const addStaff = () => {
                if (!newStaff.name || !newStaff.username || !newStaff.password) {
                    showMessage('Please fill all fields', 'error');
                    return;
                }
                if (staff.find(s => s.username === newStaff.username)) {
                    showMessage('Username already exists', 'error');
                    return;
                }
                const updated = [...staff, { 
                    id: Date.now(), 
                    ...newStaff, 
                    role: 'staff' 
                }];
                setStaff(updated);
                Storage.set('staff', updated);
                setNewStaff({
                    name: '',
                    username: '',
                    password: '',
                    freePeriodMode: 'auto',
                    manualFreePeriods: 0
                });
                showMessage('Staff added successfully! ‚úì', 'success');
            };

            const deleteStaff = (id) => {
                if (!confirm('Delete this staff member?')) return;
                const updated = staff.filter(s => s.id !== id);
                setStaff(updated);
                Storage.set('staff', updated);
                showMessage('Staff deleted successfully', 'success');
            };

            // Subject Management (EMPTY DEFAULT TYPE, 6 DEFAULT HOURS)
            const [newSubject, setNewSubject] = useState({
                className: '',
                name: '',
                subjectType: '', // EMPTY as requested
                hoursPerWeek: 6, // DEFAULT 6 as requested
                isContinuous: false,
                blockSize: 2,
                teacher: ''
            });

            const addSubject = () => {
                if (!newSubject.className || !newSubject.name || !newSubject.subjectType || !newSubject.teacher) {
                    showMessage('Please fill all required fields', 'error');
                    return;
                }
                const updated = [...subjects, { id: Date.now(), ...newSubject }];
                setSubjects(updated);
                Storage.set('subjects', updated);
                setNewSubject({
                    className: '',
                    name: '',
                    subjectType: '',
                    hoursPerWeek: 6,
                    isContinuous: false,
                    blockSize: 2,
                    teacher: ''
                });
                showMessage('Subject added successfully! ‚úì', 'success');
            };

            const deleteSubject = (id) => {
                if (!confirm('Delete this subject?')) return;
                const updated = subjects.filter(s => s.id !== id);
                setSubjects(updated);
                Storage.set('subjects', updated);
                showMessage('Subject deleted successfully', 'success');
            };

            // Generate Timetable
            const generateTimetable = () => {
                const generator = new EnhancedTimetableGenerator(classes, teachers, subjects);
                const validation = generator.validate();

                if (!validation.valid) {
                    showMessage('Validation errors: ' + validation.errors.join('; '), 'error');
                    return;
                }

                const result = generator.generate();

                if (result.success) {
                    const timetableData = {
                        classTimetables: result.classTimetables,
                        staffTimetables: result.staffTimetables
                    };
                    setTimetable(timetableData);
                    Storage.set('timetable', timetableData);
                    showMessage('üéâ Timetable generated successfully! Scroll down to view.', 'success');

                    // Auto-scroll to timetables
                    setTimeout(() => {
                        document.getElementById('view-timetables')?.scrollIntoView({ behavior: 'smooth' });
                    }, 1000);
                } else {
                    showMessage('Generation failed: ' + result.error, 'error');
                }
            };

            const showMessage = (text, type) => {
                setMessage({ text, type });
                window.scrollTo({ top: 0, behavior: 'smooth' });
                setTimeout(() => setMessage(null), 7000);
            };

            return (
                <div className="dashboard-wrapper">
                    <div className="header">
                        <div>
                            <h1>üè´ Admin Dashboard</h1>
                            <p style={{ opacity: 0.9, marginTop: '5px', fontSize: '14px' }}>
                                Welcome, {user.name}
                            </p>
                        </div>
                        <div className="header-actions">
                            <ThemeToggle />
                            <button className="btn btn-danger btn-sm" onClick={onLogout}>
                                Logout
                            </button>
                        </div>
                    </div>

                    <div className="dashboard-content">
                        {message && (
                            <div className={`alert alert-${message.type}`}>
                                {message.text}
                            </div>
                        )}

                        {/* SECTION 1: MANAGE CLASSES */}
                        <div className="section">
                            <div className="section-header">
                                <span className="section-icon">üìö</span>
                                <h2 className="section-title">Manage Classes</h2>
                            </div>

                            <div className="card">
                                <h3>‚ûï Add New Class</h3>
                                <div className="form-group">
                                    <label>Class Name (e.g., CS3A, EE2B, ME4A)</label>
                                    <input
                                        type="text"
                                        value={newClass.name}
                                        onChange={(e) => setNewClass({ name: e.target.value.toUpperCase() })}
                                        placeholder="Enter class name"
                                    />
                                </div>
                                <button className="btn btn-primary" onClick={addClass}>
                                    ‚ûï Add Class
                                </button>
                            </div>

                            <div className="card">
                                <h3>üìã Existing Classes ({classes.length})</h3>
                                {classes.length === 0 ? (
                                    <p style={{color: 'var(--text-secondary)'}}>No classes added yet. Add your first class above.</p>
                                ) : (
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>Class Name</th>
                                                <th>Subjects</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {classes.map((cls, idx) => (
                                                <tr key={cls.id}>
                                                    <td>{idx + 1}</td>
                                                    <td><strong>{cls.name}</strong></td>
                                                    <td>{subjects.filter(s => s.className === cls.name).length}</td>
                                                    <td>
                                                        <button 
                                                            className="btn btn-danger btn-sm"
                                                            onClick={() => deleteClass(cls.id)}
                                                        >
                                                            üóëÔ∏è Delete
                                                        </button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                )}
                            </div>
                        </div>

                        {/* SECTION 2: MANAGE STAFF */}
                        <div className="section">
                            <div className="section-header">
                                <span className="section-icon">üë•</span>
                                <h2 className="section-title">Manage Staff</h2>
                            </div>

                            <div className="card">
                                <h3>‚ûï Add New Staff Member</h3>
                                <div className="grid-2">
                                    <div className="form-group">
                                        <label>Full Name *</label>
                                        <input
                                            type="text"
                                            value={newStaff.name}
                                            onChange={(e) => setNewStaff({ ...newStaff, name: e.target.value })}
                                            placeholder="Dr. John Doe"
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label>Username *</label>
                                        <input
                                            type="text"
                                            value={newStaff.username}
                                            onChange={(e) => setNewStaff({ ...newStaff, username: e.target.value })}
                                            placeholder="john"
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label>Password *</label>
                                        <input
                                            type="password"
                                            value={newStaff.password}
                                            onChange={(e) => setNewStaff({ ...newStaff, password: e.target.value })}
                                            placeholder="Password"
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label>Free Period Mode</label>
                                        <select
                                            value={newStaff.freePeriodMode}
                                            onChange={(e) => setNewStaff({ ...newStaff, freePeriodMode: e.target.value })}
                                        >
                                            <option value="auto">Auto (System Calculated)</option>
                                            <option value="manual">Manual (Specify Free Periods)</option>
                                        </select>
                                    </div>
                                </div>
                                {newStaff.freePeriodMode === 'manual' && (
                                    <div className="form-group">
                                        <label>Free Periods per Week (0-30)</label>
                                        <input
                                            type="number"
                                            min="0"
                                            max="30"
                                            value={newStaff.manualFreePeriods}
                                            onChange={(e) => setNewStaff({ ...newStaff, manualFreePeriods: parseInt(e.target.value) || 0 })}
                                        />
                                    </div>
                                )}
                                <button className="btn btn-primary" onClick={addStaff}>
                                    ‚ûï Add Staff
                                </button>
                            </div>

                            <div className="card">
                                <h3>üìã Existing Staff ({teachers.length})</h3>
                                {teachers.length === 0 ? (
                                    <p style={{color: 'var(--text-secondary)'}}>No staff added yet. Add your first staff member above.</p>
                                ) : (
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>S.No</th>
                                                <th>Name</th>
                                                <th>Username</th>
                                                <th>Free Period Mode</th>
                                                <th>Subjects</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {teachers.map((s, idx) => (
                                                <tr key={s.id}>
                                                    <td>
                                                        <span className="staff-number">S{idx + 1}</span>
                                                    </td>
                                                    <td><strong>{s.name}</strong></td>
                                                    <td>{s.username}</td>
                                                    <td>
                                                        {s.freePeriodMode === 'manual' 
                                                            ? `Manual (${s.manualFreePeriods} free)` 
                                                            : 'Auto'}
                                                    </td>
                                                    <td>{subjects.filter(sub => sub.teacher === s.name).length}</td>
                                                    <td>
                                                        <button 
                                                            className="btn btn-danger btn-sm"
                                                            onClick={() => deleteStaff(s.id)}
                                                        >
                                                            üóëÔ∏è Delete
                                                        </button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                )}
                            </div>
                        </div>


                        {/* SECTION 3: MANAGE SUBJECTS */}
                        <div className="section">
                            <div className="section-header">
                                <span className="section-icon">üìñ</span>
                                <h2 className="section-title">Manage Subjects</h2>
                            </div>

                            {newSubject.className && (
                                <HoursTracker 
                                    className={newSubject.className}
                                    subjects={subjects}
                                />
                            )}

                            <div className="card">
                                <h3>‚ûï Add New Subject</h3>
                                <div className="grid-2">
                                    <div className="form-group">
                                        <label>Select Class *</label>
                                        <select
                                            value={newSubject.className}
                                            onChange={(e) => setNewSubject({ ...newSubject, className: e.target.value })}
                                        >
                                            <option value="">-- Select Class --</option>
                                            {classes.map(cls => (
                                                <option key={cls.id} value={cls.name}>{cls.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div className="form-group">
                                        <label>Subject Name *</label>
                                        <input
                                            type="text"
                                            value={newSubject.name}
                                            onChange={(e) => setNewSubject({ ...newSubject, name: e.target.value })}
                                            placeholder="e.g., Database Management, AI Lab"
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label>Subject Type *</label>
                                        <select
                                            value={newSubject.subjectType}
                                            onChange={(e) => setNewSubject({ ...newSubject, subjectType: e.target.value })}
                                        >
                                            <option value="">-- Select Type --</option>
                                            <option value="Core">Core</option>
                                            <option value="Elective">Elective</option>
                                            <option value="Lab">Lab</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    <div className="form-group">
                                        <label>Hours per Week *</label>
                                        <input
                                            type="number"
                                            min="1"
                                            max="30"
                                            value={newSubject.hoursPerWeek}
                                            onChange={(e) => setNewSubject({ ...newSubject, hoursPerWeek: parseInt(e.target.value) || 6 })}
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label>Assign Teacher *</label>
                                        <select
                                            value={newSubject.teacher}
                                            onChange={(e) => setNewSubject({ ...newSubject, teacher: e.target.value })}
                                        >
                                            <option value="">-- Select Teacher --</option>
                                            {teachers.map(t => (
                                                <option key={t.id} value={t.name}>{t.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                </div>

                                <div className="checkbox-group">
                                    <input
                                        type="checkbox"
                                        id="continuous"
                                        checked={newSubject.isContinuous}
                                        onChange={(e) => setNewSubject({ ...newSubject, isContinuous: e.target.checked })}
                                    />
                                    <label htmlFor="continuous" style={{marginBottom: 0}}>
                                        üî¨ Continuous Lab Block (2-3 periods together)
                                    </label>
                                </div>

                                {newSubject.isContinuous && (
                                    <div className="form-group">
                                        <label>Block Size</label>
                                        <select
                                            value={newSubject.blockSize}
                                            onChange={(e) => setNewSubject({ ...newSubject, blockSize: parseInt(e.target.value) })}
                                        >
                                            <option value={2}>2 Periods</option>
                                            <option value={3}>3 Periods</option>
                                        </select>
                                    </div>
                                )}

                                <button className="btn btn-primary" onClick={addSubject}>
                                    ‚ûï Add Subject
                                </button>
                            </div>

                            <div className="card">
                                <h3>üìã Existing Subjects ({subjects.length})</h3>
                                {subjects.length === 0 ? (
                                    <p style={{color: 'var(--text-secondary)'}}>No subjects added yet. Add your first subject above.</p>
                                ) : (
                                    <>
                                        {classes.map(cls => {
                                            const classSubjects = subjects.filter(s => s.className === cls.name);
                                            if (classSubjects.length === 0) return null;

                                            const totalHours = classSubjects.reduce((sum, s) => sum + s.hoursPerWeek, 0);

                                            return (
                                                <div key={cls.id} style={{marginBottom: '30px'}}>
                                                    <h4 style={{marginBottom: '15px', display: 'flex', alignItems: 'center', gap: '10px'}}>
                                                        Class: {cls.name}
                                                        <span style={{
                                                            padding: '4px 12px',
                                                            borderRadius: '20px',
                                                            fontSize: '12px',
                                                            fontWeight: 600,
                                                            background: totalHours === 30 ? '#48bb78' : '#f56565',
                                                            color: 'white'
                                                        }}>
                                                            {totalHours}/30 hours
                                                        </span>
                                                    </h4>
                                                    <table>
                                                        <thead>
                                                            <tr>
                                                                <th>Subject</th>
                                                                <th>Type</th>
                                                                <th>Hours</th>
                                                                <th>Teacher</th>
                                                                <th>Continuous</th>
                                                                <th>Actions</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {classSubjects.map(sub => (
                                                                <tr key={sub.id}>
                                                                    <td><strong>{sub.name}</strong></td>
                                                                    <td>{sub.subjectType}</td>
                                                                    <td>{sub.hoursPerWeek}h</td>
                                                                    <td>{sub.teacher}</td>
                                                                    <td>{sub.isContinuous ? `Yes (${sub.blockSize})` : 'No'}</td>
                                                                    <td>
                                                                        <button 
                                                                            className="btn btn-danger btn-sm"
                                                                            onClick={() => deleteSubject(sub.id)}
                                                                        >
                                                                            üóëÔ∏è
                                                                        </button>
                                                                    </td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            );
                                        })}
                                    </>
                                )}
                            </div>
                        </div>

                        {/* SECTION 4: GENERATE TIMETABLE */}
                        <div className="section">
                            <div className="section-header">
                                <span className="section-icon">‚ö°</span>
                                <h2 className="section-title">Generate Timetable</h2>
                            </div>

                            <div className="card">
                                <h3>üéØ Ready to Generate</h3>
                                <div style={{marginBottom: '25px', padding: '20px', background: 'var(--bg-secondary)', borderRadius: '12px'}}>
                                    <p style={{marginBottom: '15px', fontSize: '15px', lineHeight: '1.6'}}>
                                        The AI-powered algorithm will create an optimized timetable based on your inputs.
                                        It ensures:
                                    </p>
                                    <ul style={{marginLeft: '25px', lineHeight: '1.8'}}>
                                        <li>‚úÖ No free periods (all 30 periods filled)</li>
                                        <li>‚úÖ Labs placed in continuous blocks</li>
                                        <li>‚úÖ Core subjects distributed evenly</li>
                                        <li>‚úÖ No teacher conflicts</li>
                                        <li>‚úÖ Balanced teacher workload</li>
                                        <li>‚úÖ Maximum randomization for natural schedules</li>
                                    </ul>
                                </div>

                                <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: '15px', marginBottom: '25px'}}>
                                    <div style={{padding: '15px', background: 'linear-gradient(135deg, #667eea, #764ba2)', borderRadius: '12px', color: 'white', textAlign: 'center'}}>
                                        <div style={{fontSize: '13px', opacity: 0.9}}>Classes</div>
                                        <div style={{fontSize: '2em', fontWeight: 'bold'}}>{classes.length}</div>
                                    </div>
                                    <div style={{padding: '15px', background: 'linear-gradient(135deg, #48bb78, #38a169)', borderRadius: '12px', color: 'white', textAlign: 'center'}}>
                                        <div style={{fontSize: '13px', opacity: 0.9}}>Teachers</div>
                                        <div style={{fontSize: '2em', fontWeight: 'bold'}}>{teachers.length}</div>
                                    </div>
                                    <div style={{padding: '15px', background: 'linear-gradient(135deg, #ed8936, #dd6b20)', borderRadius: '12px', color: 'white', textAlign: 'center'}}>
                                        <div style={{fontSize: '13px', opacity: 0.9}}>Subjects</div>
                                        <div style={{fontSize: '2em', fontWeight: 'bold'}}>{subjects.length}</div>
                                    </div>
                                </div>

                                <button 
                                    className="btn btn-success"
                                    onClick={generateTimetable}
                                    style={{fontSize: '18px', padding: '18px 40px', width: '100%'}}
                                >
                                    ‚ú® Generate Smart Timetable
                                </button>
                            </div>
                        </div>

                        {/* SECTION 5: VIEW TIMETABLES */}
                        {timetable && (
                            <div className="section" id="view-timetables">
                                <div className="section-header">
                                    <span className="section-icon">üìä</span>
                                    <h2 className="section-title">Generated Timetables</h2>
                                </div>

                                <div className="card">
                                    <h3>üéì Class-wise Timetables</h3>
                                    {classes.map(cls => (
                                        <div key={cls.id} style={{marginBottom: '40px'}}>
                                            <h4 style={{marginBottom: '15px', fontSize: '1.3em'}}>
                                                Class: {cls.name}
                                            </h4>
                                            <TimetableGrid 
                                                timetable={timetable.classTimetables} 
                                                className={cls.name} 
                                            />
                                            <div style={{marginTop: '15px', display: 'flex', gap: '10px'}}>
                                                <button 
                                                    className="btn btn-primary btn-sm no-print"
                                                    onClick={() => exportToPDF('timetable-export', `${cls.name}_Timetable.pdf`)}
                                                >
                                                    üìÑ Download PDF
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>

                                <div className="card">
                                    <h3>üë®‚Äçüè´ Staff-wise Timetables</h3>
                                    {teachers.map(teacher => (
                                        <div key={teacher.id} style={{marginBottom: '40px'}}>
                                            <h4 style={{marginBottom: '15px', fontSize: '1.3em'}}>
                                                Teacher: {teacher.name}
                                            </h4>
                                            <StaffTimetableGrid 
                                                timetable={timetable.staffTimetables} 
                                                staffName={teacher.name} 
                                            />
                                            <div style={{marginTop: '15px', display: 'flex', gap: '10px'}}>
                                                <button 
                                                    className="btn btn-primary btn-sm no-print"
                                                    onClick={() => exportToPDF('staff-timetable-export', `${teacher.name}_Timetable.pdf`)}
                                                >
                                                    üìÑ Download PDF
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };


        // Staff Dashboard
        const StaffDashboard = ({ user, onLogout }) => {
            const [timetable] = useState(Storage.get('timetable'));

            return (
                <div className="dashboard-wrapper">
                    <div className="header">
                        <div>
                            <h1>üë®‚Äçüè´ Staff Dashboard</h1>
                            <p style={{ opacity: 0.9, marginTop: '5px', fontSize: '14px' }}>
                                Welcome, {user.name}
                            </p>
                        </div>
                        <div className="header-actions">
                            <ThemeToggle />
                            <button className="btn btn-danger btn-sm" onClick={onLogout}>
                                Logout
                            </button>
                        </div>
                    </div>

                    <div className="dashboard-content">
                        <div className="section">
                            <div className="section-header">
                                <span className="section-icon">üìÖ</span>
                                <h2 className="section-title">My Timetable</h2>
                            </div>

                            <div className="card">
                                {!timetable ? (
                                    <div style={{padding: '60px 20px', textAlign: 'center'}}>
                                        <div style={{fontSize: '60px', marginBottom: '20px'}}>üìã</div>
                                        <h3 style={{marginBottom: '10px'}}>No Timetable Generated</h3>
                                        <p style={{color: 'var(--text-secondary)'}}>
                                            Please contact the administrator to generate a timetable.
                                        </p>
                                    </div>
                                ) : (
                                    <>
                                        <StaffTimetableGrid 
                                            timetable={timetable.staffTimetables} 
                                            staffName={user.name} 
                                        />
                                        <div style={{marginTop: '20px', display: 'flex', gap: '10px', flexWrap: 'wrap'}}>
                                            <button 
                                                className="btn btn-primary no-print"
                                                onClick={() => exportToPDF('staff-timetable-export', `${user.name}_Timetable.pdf`)}
                                            >
                                                üìÑ Download PDF
                                            </button>
                                            <button 
                                                className="btn btn-primary no-print"
                                                onClick={() => window.print()}
                                            >
                                                üñ®Ô∏è Print
                                            </button>
                                        </div>
                                    </>
                                )}
                            </div>

                            {timetable && (
                                <div className="card">
                                    <h3>üìä Workload Summary</h3>
                                    {(() => {
                                        const grid = timetable.staffTimetables[user.name];
                                        if (!grid) return <p>No data available</p>;

                                        let freePeriods = 0;
                                        let teachingPeriods = 0;
                                        const dailyCounts = {};

                                        grid.forEach((day, dayIdx) => {
                                            const dayName = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'][dayIdx];
                                            dailyCounts[dayName] = 0;

                                            day.forEach(slot => {
                                                if (slot.subject === 'FREE') {
                                                    freePeriods++;
                                                } else {
                                                    teachingPeriods++;
                                                    dailyCounts[dayName]++;
                                                }
                                            });
                                        });

                                        return (
                                            <>
                                                <div className="hours-tracker">
                                                    <div className="hours-info">
                                                        <div className="hours-item">
                                                            <div className="hours-label">Teaching Periods</div>
                                                            <div className="hours-value">{teachingPeriods}</div>
                                                        </div>
                                                        <div className="hours-item">
                                                            <div className="hours-label">Free Periods</div>
                                                            <div className="hours-value">{freePeriods}</div>
                                                        </div>
                                                        <div className="hours-item">
                                                            <div className="hours-label">Workload</div>
                                                            <div className="hours-value">{((teachingPeriods/30)*100).toFixed(0)}%</div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <table style={{marginTop: '20px'}}>
                                                    <thead>
                                                        <tr>
                                                            <th>Day</th>
                                                            <th>Teaching Periods</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {Object.entries(dailyCounts).map(([day, count]) => (
                                                            <tr key={day}>
                                                                <td>{day}</td>
                                                                <td>{count}/6</td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </>
                                        );
                                    })()}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // Student Dashboard
        const StudentDashboard = ({ user, onLogout }) => {
            const [timetable] = useState(Storage.get('timetable'));
            const [classes] = useState(Storage.get('classes') || []);
            const [subjects] = useState(Storage.get('subjects') || []);
            const [selectedClass, setSelectedClass] = useState(user.className || (classes[0]?.name || ''));

            return (
                <div className="dashboard-wrapper">
                    <div className="header">
                        <div>
                            <h1>üéì Student Dashboard</h1>
                            <p style={{ opacity: 0.9, marginTop: '5px', fontSize: '14px' }}>
                                Welcome, {user.name}
                            </p>
                        </div>
                        <div className="header-actions">
                            <ThemeToggle />
                            <button className="btn btn-danger btn-sm" onClick={onLogout}>
                                Logout
                            </button>
                        </div>
                    </div>

                    <div className="dashboard-content">
                        <div className="section">
                            <div className="section-header">
                                <span className="section-icon">üìÖ</span>
                                <h2 className="section-title">Class Timetable</h2>
                            </div>

                            {classes.length > 0 && (
                                <div className="card">
                                    <div className="form-group" style={{ maxWidth: '400px' }}>
                                        <label>Select Your Class</label>
                                        <select
                                            value={selectedClass}
                                            onChange={(e) => setSelectedClass(e.target.value)}
                                            style={{fontSize: '16px', padding: '15px'}}
                                        >
                                            {classes.map(cls => (
                                                <option key={cls.id} value={cls.name}>{cls.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                </div>
                            )}

                            <div className="card">
                                {!timetable ? (
                                    <div style={{padding: '60px 20px', textAlign: 'center'}}>
                                        <div style={{fontSize: '60px', marginBottom: '20px'}}>üìã</div>
                                        <h3 style={{marginBottom: '10px'}}>No Timetable Generated</h3>
                                        <p style={{color: 'var(--text-secondary)'}}>
                                            Please contact the administrator to generate a timetable.
                                        </p>
                                    </div>
                                ) : (
                                    <>
                                        <TimetableGrid 
                                            timetable={timetable.classTimetables} 
                                            className={selectedClass} 
                                        />
                                        <div style={{marginTop: '20px', display: 'flex', gap: '10px', flexWrap: 'wrap'}}>
                                            <button 
                                                className="btn btn-primary no-print"
                                                onClick={() => exportToPDF('timetable-export', `${selectedClass}_Timetable.pdf`)}
                                            >
                                                üìÑ Download PDF
                                            </button>
                                            <button 
                                                className="btn btn-primary no-print"
                                                onClick={() => window.print()}
                                            >
                                                üñ®Ô∏è Print
                                            </button>
                                        </div>
                                    </>
                                )}
                            </div>

                            {timetable && selectedClass && (
                                <div className="card">
                                    <h3>üìö Subject Summary</h3>
                                    {(() => {
                                        const grid = timetable.classTimetables[selectedClass];
                                        if (!grid) return <p>No timetable data available</p>;

                                        const subjectCount = {};
                                        const teacherMap = {};

                                        subjects.filter(s => s.className === selectedClass).forEach(sub => {
                                            teacherMap[sub.name] = sub.teacher;
                                        });

                                        grid.forEach(day => {
                                            day.forEach(slot => {
                                                if (slot) {
                                                    subjectCount[slot.subject] = (subjectCount[slot.subject] || 0) + 1;
                                                }
                                            });
                                        });

                                        return (
                                            <table>
                                                <thead>
                                                    <tr>
                                                        <th>#</th>
                                                        <th>Subject</th>
                                                        <th>Teacher</th>
                                                        <th>Periods/Week</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {Object.entries(subjectCount).map(([subject, count], idx) => (
                                                        <tr key={subject}>
                                                            <td>{idx + 1}</td>
                                                            <td><strong>{subject}</strong></td>
                                                            <td>{teacherMap[subject] || '-'}</td>
                                                            <td>{count}</td>
                                                        </tr>
                                                    ))}
                                                    <tr style={{fontWeight: 'bold', background: 'var(--bg-secondary)'}}>
                                                        <td colSpan="3">Total</td>
                                                        <td>{Object.values(subjectCount).reduce((a,b) => a+b, 0)}/30</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        );
                                    })()}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // Main App Component
        const App = () => {
            const [user, setUser] = useState(null);

            useEffect(() => {
                initializeData();
            }, []);

            const handleLogin = (userData) => {
                setUser(userData);
            };

            const handleLogout = () => {
                if (confirm('Are you sure you want to logout?')) {
                    setUser(null);
                }
            };

            if (!user) {
                return <Login onLogin={handleLogin} />;
            }

            return (
                <>
                    {user.role === 'admin' && (
                        <AdminDashboard user={user} onLogout={handleLogout} />
                    )}
                    {user.role === 'staff' && (
                        <StaffDashboard user={user} onLogout={handleLogout} />
                    )}
                    {user.role === 'student' && (
                        <StudentDashboard user={user} onLogout={handleLogout} />
                    )}
                </>
            );
        };

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
